{% extends "receipt.sellerBase.html" %}

{% block title %}Gipsy - Cuentas por Cobrar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/accountsReceivable.css') }}"/>
{% endblock %}

{% block content %}
<div class="content">
    <div class="title-container">
        <a class="back" href="{{ url_for('homeSeller') }}"><img src="{{ url_for('static', filename='IMG/back.png') }}" alt="Back"></a>
        <div class="title-center">
            <h2>Cuentas por Cobrar</h2>
        </div>
    </div>

    <br>
    <form action="{{ url_for('accountsReceivable') }}" method="GET">
        <div class="searchBar">
            <div class="searchInputContainer">
                <input id="searchInput" type="text" placeholder="Buscar" name="search" oninput="filterTable(this.value)">
                <button type="submit">
                    <img src="{{ url_for('static', filename='IMG/lupa.png') }}" alt="Buscar">
                </button>
            </div>
        </div>
    </form>
    <br> 

    <div class="company-container">
        {% for store in stores %}
        <button class="company-name" onclick="toggleSellers('{{ store[0] }}')">{{ store[0] }} | {{ store[1] }}
            <span class="customer-count">{{ count_customers_by_store[store[0]][0] }} clientes con facturas por cobrar. Total por cobrar: {{ count_customers_by_store[store[0]][1] }} {{ count_customers_by_store[store[0]][2] }}</span>
        </button>
        <div class="company-sellers" id="sellers-{{ store[0] }}" style="display: none;">
            {% for customer in customers_by_store[store[0]] %}
            <div class="customer-container">
                <p>{{ customer[0] }} | {{ customer[1] }}{{ customer[2] }}
                    <a href="javascript:void(0)" onclick="openModal('{{ customer[0] }}', '{{ customer[3] }}', '{{ customer[1] | replace("'", "\\'") }}', '{{ customer[2] | replace("'", "\\'") }}', '{{ store[0] }}', '{{ store[1] | replace("'", "\\'") }}')">Registrar Cobranza</a>
                </p>
                <div class="separator"></div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Facturas del Cliente</h2>
        
        <!-- Contenedor del filtro dinámico -->
        <div class="filter-container" id="docFilterContainer" style="display: none;">
            <label for="docTypeFilter">Filtrar por Tipo de Documento:</label>
            <select id="docTypeFilter" onchange="applyDocFilter()">
                <option value="ALL">Todos los documentos</option>
            </select>
        </div>

        <table class="styled-table">
            <thead>
                <tr>
                    <th>N_CTA</th>
                    <th>Tipo de Documento</th>
                    <th>Moneda</th>
                    <th>Monto Original</th>
                    <th>Monto Abonado</th>
                    <th>Monto Restante</th>
                    {% if isAdmin %}
                        <th>Estado de Sincronización</th>
                    {% endif %}
                    <th>Registrar</th>
                </tr>
            </thead>
            <tbody>
                <!-- Llenado dinámico -->
            </tbody>
        </table>
        <button class="save-button" onclick="registerCollections()">Registrar Cobranza</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedAccountIDs = []; // Arreglo de AccountID de facturas seleccionadas

    function filterTable(searchTerm) {
        const companyButtons = document.querySelectorAll('.company-name');
        companyButtons.forEach(button => {
            const storeName = button.textContent.toLowerCase();
            const storeId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
            const sellersDiv = document.getElementById('sellers-' + storeId);
            
            // Cambio clave: Seleccionamos los contenedores que incluyen al cliente y su separador
            const customerContainers = sellersDiv.querySelectorAll('.customer-container');

            let storeMatches = storeName.includes(searchTerm.toLowerCase());
            let anyCustomerMatches = false;

            customerContainers.forEach(container => {
                // Buscamos el texto dentro del párrafo del contenedor
                const customerText = container.querySelector('p').textContent.toLowerCase();
                
                if (customerText.includes(searchTerm.toLowerCase())) {
                    anyCustomerMatches = true;
                    container.style.display = ''; // Mostramos el contenedor completo (con el separador)
                } else {
                    container.style.display = 'none'; // Ocultamos el contenedor completo
                }
            });

            // Si la tienda coincide o algún cliente de esa tienda coincide
            if (storeMatches || anyCustomerMatches) {
                button.style.display = '';
                // Solo expandimos automáticamente si hay un término de búsqueda, 
                // para no abrir todas las tiendas si borran el texto.
                if (searchTerm.length > 0) {
                    sellersDiv.style.display = 'block';
                }
            } else {
                button.style.display = 'none';
                sellersDiv.style.display = 'none';
            }
        });
    } 

    document.querySelectorAll('.company-name').forEach(button => {
        button.addEventListener('click', () => {
            const answer = button.nextElementSibling;
            answer.style.display = answer.style.display === 'block' ? 'none' : 'block';
        });
    });

    function formatSpanishNumber(number) {
        return number.toFixed(2)
            .replace(".", "X")
            .replace(/\B(?=(\d{3})+(?!\d))/g, ".")
            .replace("X", ",");
    }

    /**
     * Nueva función: Aplica el filtro de tipo de documento en la tabla del modal
     */
    function applyDocFilter() {
        const filterValue = document.getElementById("docTypeFilter").value;
        const rows = document.querySelectorAll("#modal .styled-table tbody tr");
        
        rows.forEach(row => {
            const docType = row.getAttribute("data-doc-type");
            if (filterValue === "ALL" || docType === filterValue) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    /*Listado de Facturas*/
    function openModal(customerId, customerIsRembd, customerName, customerLastName, storeId, storeName) {
        selectedAccountIDs = []; 

        const modal = document.getElementById("modal");
        modal.style.display = "block";

        const modalTitle = modal.querySelector("h2");
        modalTitle.textContent = `Facturas de ${customerName} ${customerLastName}`;

        const table = modal.querySelector(".styled-table");
        const button = modal.querySelector(".save-button");
        
        // Elementos del Filtro
        const filterContainer = document.getElementById("docFilterContainer");
        const filterSelect = document.getElementById("docTypeFilter");

        // Reiniciar estado del filtro
        filterContainer.style.display = "none";
        filterSelect.innerHTML = '<option value="ALL">Todos los documentos</option>';

        const existingMessages = modal.querySelectorAll("#loadingMessage, .no-invoices-message");
        existingMessages.forEach(message => message.remove());

        const loadingMessage = document.createElement("p");
        loadingMessage.id = "loadingMessage";
        loadingMessage.textContent = "Cargando facturas...";
        table.style.display = "none";
        button.style.display = "none";
        modal.querySelector(".modal-content").insertBefore(loadingMessage, table);

        const tableBody = table.querySelector("tbody");
        tableBody.innerHTML = "";

        fetch(`/get_invoices/${customerId}/${customerIsRembd}/${storeId}`)
            .then(response => {
                if (!response.ok) throw new Error("Error al obtener las facturas");
                return response.json();
            })
            .then(data => {
                const invoices = data.invoices;
                document.getElementById("loadingMessage").remove();

                if (invoices.length > 0) {
                    table.style.display = "table";
                    filterContainer.style.display = "block"; // Mostrar filtro si hay datos
                    
                    const docTypesFound = new Set(); // Para recolectar tipos únicos

                    invoices.forEach(invoice => {
                        docTypesFound.add(invoice.DocumentType);
                        const row = document.createElement("tr");
                        
                        // Guardamos el tipo de documento en un atributo de datos para filtrar
                        row.setAttribute("data-doc-type", invoice.DocumentType);

                        // Estados de sincronización
                        const statusMessages = {
                            1: "Conciliado",
                            2: "App por delante",
                            3: "Gálac por delante"
                        };
                        const statusText = statusMessages[invoice.SyncStatus] || "Desconocido";

                        // Mensajes tooltips
                        const syncHelpMessages = {
                            1: "Los abonos registrados en la Aplicación de Cobranza y en el Sistema Gálac se encuentran sincronizados",
                            2: "Los abonos registrados en la Aplicación de Cobranza no se han registrado en el Sistema Gálac",
                            3: "Los abonos registrados en el Sistema Gálac no se han registrado en la Aplicación de Cobranza"
                        };
                        const helpMsg = syncHelpMessages[invoice.SyncStatus] || "Estado no definido";

                        // Estilo color status
                        const syncStatusBadge = {
                            1: "matched",
                            2: "appAhead",
                            3: "galacAhead"
                        }
                        const statusClass = syncStatusBadge[invoice.SyncStatus] || "";

                        row.innerHTML = `
                            <td>${invoice.N_CTA}</td>
                            <td>${invoice.DocumentType}</td>
                            <td>${invoice.Currency}</td>
                            <td>${formatSpanishNumber(invoice.Amount)}</td>
                            <td>${formatSpanishNumber(invoice.Balance)}</td>
                            <td>${formatSpanishNumber(invoice.Remaining)}</td>
                            {% if isAdmin %}
                                <td>
                                    <div class="sync-container">
                                        <span class="status-badge ${statusClass}">${statusText}</span>
                                        <div class="tooltip-container">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">${helpMsg}</span>
                                        </div>
                                    </div>
                                </td>
                            {% endif %}
                            <td><input type="checkbox" class="invoice-checkbox" data-account-id="${invoice.AccountID}" /></td>
                        `;
                        tableBody.appendChild(row);
                    });

                    // Llenar el select solo con los tipos que existen en este modal
                    docTypesFound.forEach(type => {
                        const option = document.createElement("option");
                        option.value = type;
                        option.textContent = type;
                        filterSelect.appendChild(option);
                    });

                    button.style.display = "block";
                } else {
                    const noInvoicesMessage = document.createElement("p");
                    noInvoicesMessage.className = "no-invoices-message";
                    noInvoicesMessage.textContent = "Este cliente no tiene facturas pendientes.";
                    modal.querySelector(".modal-content").appendChild(noInvoicesMessage);
                }
            })
            .catch(error => {
                console.error("Error al cargar las facturas:", error);
                const loadingMessage = document.getElementById("loadingMessage");
                if (loadingMessage) loadingMessage.textContent = "No se pudieron cargar las facturas.";
            });
    }

    function closeModal() {
        document.getElementById("modal").style.display = "none";
        selectedAccountIDs = []; 
    }

    document.addEventListener("change", function(event) {
        if (event.target.classList.contains("invoice-checkbox")) {
            const accountID = event.target.getAttribute("data-account-id");
            if (event.target.checked) {
                selectedAccountIDs.push(accountID);
            } else {
                selectedAccountIDs = selectedAccountIDs.filter(id => id !== accountID);
            }
        }
    });

    function registerCollections() {
        if (selectedAccountIDs.length > 0) {
            sessionStorage.setItem("selectedAccountIDs", JSON.stringify(selectedAccountIDs));
            let selectedCurrencies = new Set();
            for (const accountID of selectedAccountIDs) {
                const checkbox = document.querySelector(`.invoice-checkbox[data-account-id="${accountID}"]`);
                const invoice = checkbox.closest("tr");
                const currency = invoice.querySelector("td:nth-child(3)").textContent.trim();
                selectedCurrencies.add(currency);
                if (selectedCurrencies.size > 1) {
                    alert("Las facturas seleccionadas tienen diferentes monedas. Seleccione facturas de una misma moneda para registrar la cobranza.");
                    return;
                }
            }
            const accountIdsString = selectedAccountIDs.join('-');
            window.location.href = "{{ url_for('accountsForm', account_ids='ACCOUNT_IDS') }}".replace('ACCOUNT_IDS', accountIdsString);
        } else {
            alert("Por favor, selecciona al menos una factura.");
        }
    }
</script>
{% endblock %}