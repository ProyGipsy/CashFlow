{% extends "receipt.adminBase.html" %}
{% block title %}Gipsy - Vendedores{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/sellersList.css') }}"/>
{% endblock %}
{% block content %}
<div class="content">
    <div class="title-container">
        <a class="back" href="{{ url_for('homeAdmin') }}"><img src="{{ url_for('static', filename='IMG/back.png') }}" alt="Back"></a>
        <div class="title-center">
            <h2>Vendedores</h2>
        </div>
    </div>
    <br>
    <form action="{{ url_for('sellers') }}" method="GET">
        <div class="searchBar">
            <div class="searchInputContainer">
                <input id="searchInput" type="text" placeholder="Buscar" name="search" oninput="filterTable(this.value)">
                <button type="submit">
                    <img src="{{ url_for('static', filename='IMG/lupa.png') }}" alt="Buscar">
                </button>
            </div>
        </div>
    </form>    
    <br>
    <div class="company-container">
        {% for store in stores %}
        <button class="company-name" onclick="toggleSellers('{{ store[0] }}')">{{ store[0] }} | {{ store[1] }}
            <span class="customer-count">{{ count_sellers_by_store[store[0]] }} vendedores</span>
        </button>
        <div class="company-sellers" id="sellers-{{ store[0] }}" style="display: none;">
            {% for seller in sellers_by_store[store[0]] %}
            <div class="customer-container">
                <p>{{ seller[0] }} | {{ seller[1] }} <a href="{{ url_for('sellerDetails', seller_id=seller[0]) }}"><img src="{{ url_for('static', filename='IMG/details.png') }}" alt="Detalles"></a></p>
                <div class="separator"></div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function filterTable(searchTerm) {
    const lowerSearch = searchTerm.toLowerCase();
    const companyButtons = document.querySelectorAll('.company-name');

    companyButtons.forEach(button => {
        const storeName = button.textContent.toLowerCase();
        // Extraemos el ID del store del atributo onclick
        const storeId = button.getAttribute('onclick').match(/'([^']+)'/)[1];
        const sellersDiv = document.getElementById('sellers-' + storeId);
        
        // Seleccionamos los contenedores que tienen al vendedor y su separador (<hr>)
        const sellerContainers = sellersDiv.querySelectorAll('.customer-container');

        let storeMatches = storeName.includes(lowerSearch);
        let anySellerMatches = false;

        sellerContainers.forEach(container => {
            // Buscamos el texto dentro del <p> que está dentro del contenedor
            const sellerText = container.querySelector('p').textContent.toLowerCase();
            
            if (sellerText.includes(lowerSearch)) {
                anySellerMatches = true;
                container.style.display = ''; // Muestra contenedor + hr
            } else {
                container.style.display = 'none'; // Oculta contenedor + hr
            }
        });

        // Lógica de visibilidad de la tienda (Botón principal)
        if (storeMatches || anySellerMatches) {
            button.style.display = '';
            
            // Si el usuario escribió algo y hay coincidencia, expandimos el acordeón
            if (lowerSearch.length > 0) {
                sellersDiv.style.display = 'block';
                
                // Si la tienda coincide por nombre pero no hay vendedores que coincidan individualmente,
                // mostramos todos los vendedores de esa tienda para que no quede vacía.
                if (storeMatches && !anySellerMatches) {
                    sellerContainers.forEach(c => c.style.display = '');
                }
            } else {
                // Si el buscador está vacío, colapsamos las listas (comportamiento original)
                sellersDiv.style.display = 'none';
            }
        } else {
            // Si nada coincide, ocultamos todo el bloque
            button.style.display = 'none';
            sellersDiv.style.display = 'none';
        }
    });
}

function toggleSellers(storeId) {
    const sellersDiv = document.getElementById('sellers-' + storeId);
    sellersDiv.style.display = sellersDiv.style.display === 'block' ? 'none' : 'block';
}
</script>
{% endblock %}