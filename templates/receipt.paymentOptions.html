{% extends "receipt.adminBase.html" %}

{% block title %}Gipsy - Opciones de Pago{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='CSS/paymentOptions.css') }}"/>
{% endblock %}

{% block content %}
<div class="content">
    <div class="title-container">
        <a class="back" href="{{ url_for('homeAdmin') }}"><img src="{{ url_for('static', filename='IMG/back.png') }}" alt="Back"></a>
        <div class="title-center">
            <h2>Opciones de Pago</h2>
        </div>
    </div>

    <div class="filter-row-container">
        <form action="#" method="GET" class="history-filters">
            <div class="filter-line">
                
                <div class="filter-group">
                    <label for="store">Tienda:</label>
                    <select id="store" name="store"></select>
                </div>
                <div class="filter-group">
                    <label for="currency">Moneda:</label>
                    <select id="currency" name="currency"></select>
                </div>
                <div class="filter-group">
                    <label for="tender">Tender:</label>
                    <select id="tender" name="tender"></select>
                </div>
                <button type="button" id="reset-filters" class="btn-filter">Reiniciar</button>
            </div>
        </form>
    </div>

    <button class="add-button">Agregar Opción de Pago</button>

    <div id="no-results" style="display:none; padding:16px; color:#444;">No hay opciones de pago que cumplan con esos filtros.</div>

    <table class="styled-table" id="paymentOptions-table">
        <thead>
            <tr>
                <th>Tienda</th>
                <th>Moneda</th>
                <th>Tender</th>
                <th>Cuenta Bancaria</th>
                <th>Destino</th>
                <th>Descripción</th>
                <th>RIF</th>
            </tr>
        </thead>
        <tbody>
            {% for payments in payment_options %}
            <tr data-id="{{payments[0]}}">
                <td>{{payments[1]}}</td>
                <td>{{payments[2]}}</td>
                <td>{{payments[3]}}</td>
                <td>{{payments[4]}}</td>
                <td>{{payments[5]}}</td>
                <td>{{payments[6]}}</td>
                <td>{{payments[7]}}</td>
                <td><span class="edit-icon" onclick="editRow(this)"><img src="{{ url_for('static', filename='IMG/edit.png') }}" alt="Editar"></span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination">
        {% if current_page > 1 %}
            <a href="{{ url_for('paymentOptions', page=current_page-1) }}">Anterior</a>
        {% endif %}

        {% if total_pages <= 10 %}
            {# Si hay 10 o menos, las mostramos todas #}
            {% for p in range(1, total_pages + 1) %}
                <a href="{{ url_for('paymentOptions', page=p) }}" class="{% if p == current_page %}active{% endif %}">{{ p }}</a>
            {% endfor %}
        {% else %}
            {# Lógica de puntos suspensivos: 5 primeras y 5 últimas #}
            {% for p in range(1, 6) %}
                <a href="{{ url_for('paymentOptions', page=p) }}" class="{% if p == current_page %}active{% endif %}">{{ p }}</a>
            {% endfor %}

            <span class="dots">...</span>

            {% for p in range(total_pages - 4, total_pages + 1) %}
                <a href="{{ url_for('paymentOptions', page=p) }}" class="{% if p == current_page %}active{% endif %}">{{ p }}</a>
            {% endfor %}
        {% endif %}

        {% if current_page < total_pages %}
            <a href="{{ url_for('paymentOptions', page=current_page+1) }}">Siguiente</a>
        {% endif %}
    </div>

{% endblock %}

{% block extra_js %}
<script>
    const filtersData = {{ filters|tojson|safe }};
    let currentPage = {{ current_page }};

    function initialPopulate() {
        const storeSel = document.getElementById('store');
        const currSel = document.getElementById('currency');
        const tenderSel = document.getElementById('tender');

        const fill = (sel, data) => {
            if (!sel) return;
            sel.innerHTML = '<option value="ALL">Todas</option>';
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.textContent = item;
                sel.appendChild(opt);
            });
        };

        fill(storeSel, filtersData.stores);
        fill(currSel, filtersData.currencies);
        fill(tenderSel, filtersData.tenders);
    }

    // Función para cambiar de página sin perder filtros
    async function goToPage(page) {
        currentPage = page;
        await updateTable();
    }

    async function updateTable() {
        const params = new URLSearchParams({
            page: currentPage,
            store: document.getElementById('store').value,
            currency: document.getElementById('currency').value,
            tender: document.getElementById('tender').value
        });

        try {
            const response = await fetch(`/api/paymentOptions?${params.toString()}`);
            const data = await response.json();
            
            renderRows(data.options);
            // Pasamos current_page y total_pages que vienen del JSON
            renderPaginationUI(data.page, data.total_pages); 
        } catch (error) {
            console.error("Error al actualizar la tabla:", error);
        }
    }

    function renderPaginationUI(current, total, totalRecords) {
        const container = document.querySelector('.pagination'); // Usamos la clase que ya tienes
        if (!container) return;
        
        container.innerHTML = '';

        // Condición 1: Si hay menos de 50 resultados (o solo 1 página), no mostrar paginado
        // Nota: total es total_pages. Si es 1 o menos, no hace falta paginar.
        if (total <= 1) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'flex'; // O 'block', según tu CSS

        // --- Botón Anterior ---
        if (current > 1) {
            container.innerHTML += `<a href="javascript:void(0)" onclick="goToPage(${current - 1})">Anterior</a>`;
        }

        // --- Lógica de números ---
        if (total <= 10) {
            for (let i = 1; i <= total; i++) {
                container.innerHTML += `<a href="javascript:void(0)" onclick="goToPage(${i})" class="${i === current ? 'active' : ''}">${i}</a>`;
            }
        } else {
            // Primeras 5
            for (let i = 1; i <= 5; i++) {
                container.innerHTML += `<a href="javascript:void(0)" onclick="goToPage(${i})" class="${i === current ? 'active' : ''}">${i}</a>`;
            }
            container.innerHTML += `<span class="dots">...</span>`;
            // Últimas 5
            for (let i = total - 4; i <= total; i++) {
                container.innerHTML += `<a href="javascript:void(0)" onclick="goToPage(${i})" class="${i === current ? 'active' : ''}">${i}</a>`;
            }
        }

        // --- Botón Siguiente ---
        if (current < total) {
            container.innerHTML += `<a href="javascript:void(0)" onclick="goToPage(${current + 1})">Siguiente</a>`;
        }
    }

    function renderRows(options) {
        const tbody = document.querySelector('#paymentOptions-table tbody');
        const table = document.getElementById('paymentOptions-table');
        const noResults = document.getElementById('no-results');
        
        tbody.innerHTML = '';

        // Condición 2: Si no hay resultados, mostrar mensaje y ocultar tabla
        if (options.length === 0) {
            table.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        // Si hay resultados, asegurar que la tabla sea visible
        table.style.display = 'table';
        noResults.style.display = 'none';

        options.forEach(opt => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-id', opt[0]);
            tr.innerHTML = `
                <td>${opt[1]}</td>
                <td>${opt[2]}</td>
                <td>${opt[3]}</td>
                <td>${opt[4]}</td>
                <td>${opt[5]}</td>
                <td>${opt[6]}</td>
                <td>${opt[7]}</td>
                <td><span class="edit-icon" onclick="editRow(this)"><img src="/static/IMG/edit.png"></span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function resetFilters() {
        // 1. Buscamos los selects por su ID
        const storeSel = document.getElementById('store');
        const currSel = document.getElementById('currency');
        const tenderSel = document.getElementById('tender');

        // 2. Los devolvemos al valor inicial
        if (storeSel) storeSel.value = 'ALL';
        if (currSel) currSel.value = 'ALL';
        if (tenderSel) tenderSel.value = 'ALL';

        // 3. Reiniciamos la página a la primera
        currentPage = 1;

        // 4. Refrescamos la tabla con los datos originales
        updateTable();
    }

    // Inicialización al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        initialPopulate();
        renderPaginationUI(currentPage, {{ total_pages }}); // Carga inicial de la paginación
        
        // Evento para el botón de Reiniciar
        const resetBtn = document.getElementById('reset-filters');
        if (resetBtn) {
            resetBtn.addEventListener('click', resetFilters);
        }

        // Eventos de filtros
        document.querySelectorAll('.history-filters select').forEach(select => {
            select.addEventListener('change', () => {
                currentPage = 1;
                updateTable();
            });
        });
    });
</script>
{% endblock %}